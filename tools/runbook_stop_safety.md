# Stop 安全確認 Runbook

start/stop 連打や stop 直後の残り火に対して、**ログ観測で安全を確認する**手順を固定する。推測で安全と言わず、確認ログ条件を明文化する。

---

## 1) start → 即 stop を 10 回繰り返す手順

1. GUI を起動し、Control タブで「取引ON」をクリック（start）。
2. **すぐに**「取引OFF」をクリック（stop）。待たずに stop する。
3. 上記 1〜2 を **10 回** 繰り返す（start → 即 stop × 10）。
4. 各 stop 後、コンソール／ログ出力を確認し、下記「2) stop 後のログ条件」を満たすかチェックする。

---

## 2) stop 後に許容されるログ / 禁止ログ

### 確認の前提

- **基準時刻**: `[trade_loop] stopped reason=...` が出力された時点を「stop 完了」とする。
- それ**以降**のログのみを「stop 後のログ」として評価する。

### 許容ログ（stop 後に出てよい）

| ログ例 | 意味 |
|--------|------|
| `[ORDER] cancelled reason=run_id_stale_final ...` | stop 後の残り火が run_id 不一致でキャンセルされた（正常な最終防衛）。 |
| `GATE_DENIED`（decisions またはログ上） | ガードで拒否された（発注していない）。 |

※ 上記以外の「発注しない／取り消す」系ログも、**禁止ログに該当しなければ**許容とする。

### 禁止ログ（安全確認 NG）

| 条件 | 判定 |
|------|------|
| **`[trade_loop] stopped` の後に `[ORDER] sent` が出る** | **禁止**。stop 完了後に新規発注が行われているため、残り火／連打対策が効いていない。 |

**合格基準**: 10 回すべてで、「禁止ログ」が 1 件も出ないこと。1 回でも `stopped` の後に `[ORDER] sent` が出た場合は不合格とし、原因調査を行う。

---

## 3) join timeout が出た場合の一次対応（状況メモテンプレ）

stop 時に `[trade_loop] stop join timeout` が出た場合は、以下をメモして一次対応とする。

```text
【join timeout 状況メモ】
- 日時:
- 再現手順（例: start→即stop の何回目か）:
- 直前に出ていたログ（最後の5〜10行程度）:
- その後の挙動（GUI応答・プロセス終了有無など）:
- 環境（Python版・OS・MT5接続有無）:
```

上記を記録したうえで、必要に応じてスレッド/join 実装の確認やログ追加検討に回す。
