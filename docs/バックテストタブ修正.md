達成したこと

Backtestタブの期間指定が完全に安定

UIで指定した開始日・終了日が勝手に変更されない

ローソク足CSVで読み込んだ期間＝バックテスト実行期間

CSV不足分を自動的にMT5から補完

ensure_data() → make_csv_from_mt5.py

PYTHONPATH / sys.executable 対応により subprocess 実行も安定

Backtest実行が確実に走る

--tf → --timeframe

--wfo → --mode {bt,wfo}

argparse 仕様と完全一致

成功時のみ指定期間の結果をロード

失敗時に「過去のバックテスト結果を誤表示」する問題を解消

成果物

logs/backtest/USDJPY-/M5/backtest_YYYY-MM-DD_to_YYYY-MM-DD/

equity_curve.csv

trades.csv

decisions.jsonl

monthly_returns.csv

GUI・CLI・MT5 の責務分離は維持（gui / services / core）

現在残っている warning（次スレッドで対応）

KPIService

KPIService.load_equity_curve_with_action_bands()
got an unexpected keyword argument 'equity_csv'


sklearn / LightGBM

X does not have valid feature names,
but LGBMClassifier was fitted with feature names


※ 動作自体は問題なし。ログ品質と将来の事故防止のために修正予定。

バックテストの修正
目的

Backtest 実行後に出ていた 2種類の warning を解消

運用ログをクリーンな状態にする

対象 warning と結論
1) KPIService.load_equity_curve_with_action_bands()

unexpected keyword argument 'equity_csv'

原因

GUI 側と KPIService 側で引数仕様がズレていた

対応

KPIService の正しい引数仕様を基準に GUI 呼び出しを修正

結果

warning 完全解消

Backtest / GUI / KPI の責務境界を維持したまま整合

2) sklearn / LightGBM

X does not have valid feature names

原因（本質）

学習時：DataFrame（feature 名あり）

推論時：ndarray（feature 名なし）

さらに feature_names_in_ を持たない LightGBM 系モデルも混在

重要な発見

warning は1箇所ではなく、複数経路から発生していた

T-42 で確定していた
「feature_order は model.feature_name_ を唯一の真実とする」
という設計思想が、Backtest/GUI 側で完全には貫かれていなかった

対応

app/strategies/ai_strategy.py

_predict_proba_generic() を中心に修正

対応した feature 名ソース：

feature_names_in_

feature_name_

booster_.feature_name()

bst.feature_name()

列数・順序が一致する場合のみ DataFrame 化

合わない場合は無理に合わせず ndarray fallback（事故防止）

-W error による例外化で warning 発生源が無いことを確認

結果

Backtest / GUI 実行ともに
sklearn warning 完全消滅

filterwarnings 等の隠蔽処理は未使用（健全）

副次的に得られた成果

T-42 の「重要な決め事」

特徴量は 20 個固定

順序は model.feature_name_ に従う

shape check を無効化しない

これらが Backtest / GUI / 運用コードに完全反映された

グラフの水色帯（HOLD / BLOCKED）は

異常ではなく

AI が「何もしなかった理由」を可視化した運用KPI

正常動作を確認

最終状態

Backtest 完走：OK

GUI 表示：OK

生成物（equity / trades / timeline / decisions）：OK

warning：0

設計思想（T-42 → T-43）：破綻なし・一貫性あり

1. feature_order の fail-fast 検証が完全に機能

Backtest 起動前に以下を必ず検証するようになった

active_model.json の expected_features

実際の推論入力の feature 順・数

不一致があれば

理由つき RuntimeError

Buy&Hold などへのフォールバック無し

運用事故を未然に遮断

👉 「静かに間違ったモデルで回ってた」系の事故は、構造的に起きなくなった

2. active_model.json を 唯一の真実（Single Source of Truth）に確立

models/active_model.json と ルート active_model.json を同期

以下が常に揃う状態を保証：

expected_features

feature_hash

model_path

writer 側（promote / swap / retrain 系）で enrich 前提の設計に整理

👉 「どのモデル・どの特徴量で動いているか」が曖昧になる経路を封鎖

3. sklearn / LightGBM の

X does not have valid feature names 警告を根本解決

AISvc.predict で：

expected_features を元に 列名付き DataFrame を必ず構築

欠損・順序ズレは早期エラー

警告を一時 error に昇格 → 発生源を特定 → 恒久対応

現在：

warning 完全消滅

推論入力の仕様が明文化・固定化

👉 「警告が出るけど動くからOK」という不安定状態を卒業

4. Backtest の 期間指定が安全に短縮可能

--start-date / --end-date が GUI / CLI 両方で正しく反映

例：

2025-12-03 ~ 2026-01-03

2025-12-28 ~ 2026-01-03

CSV 実体と期間不整合も fail-fast

👉 重い全期間BTを回さなくても、検証ループが高速化

5. GUIログの 文字化けを完全解消

原因：QProcess 出力の デコード不一致（cp932 vs UTF-8）

対応：

GUI側で stdout / stderr を 必ず UTF-8 decode

PYTHONUTF8=1 を子プロセス環境に注入

結果：

pickleがロードされました

日本語ログが GUIでも完全再現

👉 CLI と GUI のログが「同一の真実」になった

feature_order の fail-fast 検証：
→ 不整合時は即停止、正常時は警告なしで完走 ✔

LightGBM の feature names 警告：
→ 入力列の正規化で完全解消 ✔

GUI からの 期間指定 Backtest：
→ CLI / GUI 両方で一致した挙動 ✔

WFO チェックボックス実行：
→ mode=wfo で実行、train / test 分離、equity_test.csv 描画 ✔

GUI 側の 自動ディレクトリ解決・描画ロジック：
→ WFO/BT 両対応、列判定ベースで安定 ✔

文字化け・ログ表示・UTF-8 周り：
→ 実運用に耐える状態 ✔

今の状態は
「WFO対応のBacktest基盤が、事故防止ガード付きで完成」
と言っていいです。