# 仮想実行バックテスト仕様書 v5.3（Virtual BT編）

本仕様書は、fxbot プロジェクトにおける **仮想実行バックテスト（Virtual Backtest / 以下 Virtual BT）** の仕様を定義する。

目的は以下の3点である。

* リアル自動売買と**同一の意思決定フロー**を仮想環境で再現すること
* 実運用改善に直結する**再現可能なログと分析UI**を提供すること
* GUI / Services / Core の責務境界を厳守し、将来拡張に耐える構造を保つこと

---

## 1. 全体概要

* Virtual BT は **新規タブ**として GUI に追加される
* リアル自動売買との差分は「データ入力元」と「約定先」のみ
* 実行結果はすべて `D:\fxbot\logs\BTlog` 配下に保存される

---

## 2. Virtual BT タブ UI 仕様

### 2.1 レイアウト構成

* 上：コントロールバー
* 下：資産曲線（エクイティカーブ）
* 右：ミニ情報ペイン（任意）
* 取引リストは **別窓（Trade List Window）** で表示

画面比率の目安：

* 左：右 = 70% : 30%
* 上部コントロールバー：固定高（約120px）

---

### 2.2 上：コントロールバー

#### (1) 期間指定

* 開始日（QDateEdit）
* 終了日（QDateEdit）
* デフォルト：

  * 終了日 = 今日
  * 開始日 = 今日の1ヶ月前
* クイック選択（任意）：1W / 1M / 3M / 6M / 1Y / ALL

#### (2) 初期資金

* 数値入力（円）
* デフォルト：1,000,000
* 0以下は不可

#### (3) threshold セット

* 3パターン入力を前提
* デフォルト：0.45 / 0.50 / 0.55
* 有効な threshold が1つの場合：単一実行
* 複数ある場合：比較モード（複数曲線）

#### (4) ストリーミング切替

* チェックボックス：ストリーミング表示
* デフォルト：ON

#### (5) 開始 / 停止

* ボタン表記：開始 ⇄ 停止
* 開始時：

  * run_id を生成
  * UI 入力をロック
* 停止時：

  * 安全に中断要求
  * ステータスを「停止（途中結果）」へ

#### (6) ステータス表示

* READY / RUNNING / STOPPING / DONE / ERROR
* 補助情報（任意）：bars_processed / trades_count / current_time

---

## 3. ストリーミング更新仕様（確定）

* 更新単位：**Nバーごと（デフォルト：5バー）**
* GUI 描画更新：500ms ごとに差分チェック
* equity_curve.csv は追記方式
* CSV 全読み込みは禁止（差分のみ）

---

## 4. 資産曲線（エクイティカーブ）

### 4.1 表示仕様

* 単一 threshold：1本表示
* 比較モード：最大3本を同一 Axes に重ね描画
* エントリー / 決済マーカー表示（任意）

### 4.2 equity_curve.csv

* 既存仕様を踏襲
* カラム：

  * time
  * equity
  * signal

signal の定義：

* ENTER_BUY
* ENTER_SELL
* EXIT
* HOLD

---

## 5. 取引リスト / 詳細分析 UI

### 5.1 Trade List Window（別窓）

#### 表示モード

**Compact（デフォルト）**

* trade_id
* entry_time
* side
* pnl_jpy
* exit_reason

**Detail**

* trade_id
* entry_time / entry_price
* exit_time / exit_price
* side
* pnl_jpy
* pnl_pips（任意）
* threshold
* signal_strength（proba / diff）
* exit_reason
* MAE / MFE
* model_id（存在する場合）

#### 操作

* ダブルクリック：Trade Detail Window を開く
* 右クリック：

  * 詳細を開く
  * JSON コピー
  * CSV エクスポート
  * フィルタ（side / 勝敗 / exit_reason / threshold）

---

### 5.2 Trade Detail Window

#### 表示内容

* 上：ローソク足（エントリー〜決済を含む）
* 下：判断系列（proba / diff / threshold）
* 右：判断理由テキスト

#### 表示レンジ

* pre_bars = 30
* post_bars = 10
* 表示範囲：entry_time - pre_bars 〜 exit_time + post_bars

#### 制約

* 表示内容は **ログから復元可能な情報のみ**
* 推測による理由生成は禁止

---

## 6. ログ保存仕様（BTlog）

### 6.1 保存先

```
D:\fxbot\logs\BTlog\runs\<run_id>\
```

### 6.2 run_id 命名規則（確定）

```
YYYYMMDD_HHMMSS_<symbol>_<tf>_<mode>
例：20260124_093015_USDJPY_M5_VBT
```

### 6.3 保存ファイル

* bt_app.log
* decisions.jsonl
* trades.jsonl
* equity_curve.csv
* metrics.json
* config.json

---

## 7. JSON ログ仕様

### 7.1 trades.jsonl（必須キー）

* run_id
* trade_id
* threshold
* side
* entry_time
* entry_price
* exit_time
* exit_price
* pnl_jpy
* exit_reason
* entry_signal（proba / diff / threshold）
* MAE / MFE（算出する場合）

#### trades.jsonl サンプル1行（ダミー）

```json
{"run_id":"20260124_093015_USDJPY_M5_VBT","trade_id":12,"threshold":0.5,"side":"BUY","entry_time":"2026-01-24T10:15:00","entry_price":147.235,"exit_time":"2026-01-24T11:05:00","exit_price":147.420,"pnl_jpy":1850,"exit_reason":"TP","entry_signal":{"proba_buy":0.62,"proba_sell":0.38,"diff":0.24,"threshold":0.5},"mae":-420,"mfe":2100}
```

### 7.2 decisions.jsonl（必須キー）

* run_id
* time
* threshold
* proba_buy
* proba_sell
* diff
* decision（ENTER_BUY / ENTER_SELL / HOLD）
* denied_reasons（配列）
* features_snapshot（最小限）

#### decisions.jsonl サンプル1行（ダミー）

```json
{"run_id":"20260124_093015_USDJPY_M5_VBT","time":"2026-01-24T10:15:00","threshold":0.5,"proba_buy":0.62,"proba_sell":0.38,"diff":0.24,"decision":"ENTER_BUY","denied_reasons":[],"features_snapshot":{"trend":"UP","volatility":0.18}}
```

---

## 8. exit_reason（列挙・確定）

* TP
* SL
* TIMEOUT
* REVERSE_SIGNAL
* STOP_BUTTON
* END_OF_DATA
* ERROR

---

## 9. 仮想約定ルール（最低限）

* 約定価格：**次バーの始値（M5 Open）**
* スリッページ：なし
* 手数料：なし

---

## 10. metrics.json 生成ルール

* 実行完了時（DONE）：生成
* 停止時：途中結果として生成
* RUNNING 中：生成しない

### 10.1 threshold 比較時の metrics.json 構造（確定）

**Map 形式（threshold → metrics）を採用する。**

```json
{
  "run_id": "20260124_093015_USDJPY_M5_VBT",
  "mode": "MULTI_THRESHOLD",
  "metrics_by_threshold": {
    "0.45": {"total_pnl": 12400,"win_rate": 0.53,"max_dd": -3200,"trades": 85},
    "0.50": {"total_pnl": 18600,"win_rate": 0.56,"max_dd": -2800,"trades": 72},
    "0.55": {"total_pnl": 9100,"win_rate": 0.49,"max_dd": -4100,"trades": 60}
  }
}
```

* キーは threshold（文字列）
* 各値は既存 metrics.json と同一スキーマ
* 単一 threshold の場合は `metrics_by_threshold` に1要素のみ格納

---

## 11. 停止時の保証

* 成立済みトレードはすべてログに残る
* 未決済ポジションは強制決済しない
* metrics.json は途中結果として生成

---

## 12. 責務境界

* GUI（app/gui）：操作・描画・別窓管理
* Services（app/services）：Virtual BT 起動・パス管理・要約生成
* Core（app/core）：CSV 駆動の実行エンジン（Strategy / Filter / SimulatedExecution）

---

## 13. 位置づけ（設計思想）

Virtual BT は「検証用の簡易バックテスト」ではなく、
**実運用改善のための研究装置**である。

すべての判断はログに残り、
すべての表示はログから再現できなければならない。
