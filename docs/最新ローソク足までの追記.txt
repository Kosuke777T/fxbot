MT5 時刻ズレ修正 → CSVが最新足まで追記）
0) 症状（最初に起きていたこと）

MT5の最新M5は進んでいるのに、USDJPY_M5.csv の time.max が 2026-01-19 15:00:00 で止まり続ける

ensure_ohlcv_uptodate() は mt5_last が進んでいるのに append_rows=0 のまま

copy_rates_range() が返す max が変、copy_rates_from() フォールバックも collected 0 rows になっていた

1) 原因（確定）

MT5が返す tick.time(epoch) がローカルの now_epoch より約 +2時間未来になっていた

観測ログ：delta_sec=7198 → delta_hours_round=2

その結果、epoch→JST 変換を “UTC基準” として扱うロジックがズレて、

range取得の時刻が不正

fallback paging の “終端 dt_to” も不正

→ 必要区間に入らず 0行になる

2) 対応方針（最小差分）

“ミチビキ内部の naive datetime は JST” を前提に維持したまま、

MT5のepochがUTCからズレている分だけ補正する（+2h 等）

さらに、MT5 APIが naive datetime を「サーバ時刻」として解釈している可能性に備えて、

fallback（copy_rates_from）に渡す dt_to を server-naive に寄せる

3) 実装した修正（要点）
A. SERVER_OFFSET_SEC を導入（グローバル）

SERVER_OFFSET_SEC: int = 0 を追加

main() の [time_audit] で now_epoch と tick_epoch の差分から 1時間丸めで確定

例：SERVER_OFFSET_SEC = 7200

B. epoch→JST変換 jst_from_mt5_epoch() に補正を追加

pd.to_datetime(..., utc=True) で作った時刻から
SERVER_OFFSET_SEC を引いて補正してから JST化する

C. copy_rates_from() 用に _to_server_naive() を追加

JST naive → server naive（= “壁時計”）に寄せる

fallback では dt_to = _to_server_naive(end_ts) を使うよう変更

D. 観測ログを強化してチョークポイントを可視化

[time_audit]（ローカルとMT5のズレ）

rangeの range_insufficient ログ

fallbackの df_raw.time.max epoch / utc / jst ログ

df_new.time dtype と merged.max ログ

4) 結果（観測で確定：復旧）

SERVER_OFFSET_SEC=7200 を観測で確定

fallbackが collected 0 → fetched rows=57 に改善

USDJPY_M5.csv の末尾が更新：

csv_tail_before: 2026-01-19 15:00:00

csv_tail_after : 2026-01-19 19:45:00

append_rows=57

CSV実体でも確認：

time.max: 2026-01-19 19:45:00

rows: 112816

5) 2026-01-19 15:00:00 は何の時間だった？

これは “CSV（JST naive運用）の最終ローソク足の時刻”

当初は時刻ズレのせいで、その先（15:05〜）が取得・マージされず、CSVの最終時刻が15:00で固定されていた

今回の補正で 15:05以降が入って更新された

6) いまの状態（完了判定）

✅ UnicodeDecodeError も解消済み（subprocess出力デコード耐性）

✅ symbol正規化（CSVパス用）と MT5 symbol（実取得用）の分離も完了

✅ 時刻ズレ（server_offset +2h）を吸収して、M5自動更新が最新足まで追記できる状態に復旧

✅ ensure_ohlcv_uptodate() が append_rows > 0 を出し、推論も動く（infer_rowsが出る）