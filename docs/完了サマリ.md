#########################################################
#目的

threshold（best_thr=0.45）が
「一時的な最適値」か「戦略の性格として安定した値」かを判断するための
時間方向の安定性評価基盤を構築する

実装・確認で確定したこと（観測ベース）

weekly_retrain.py

Walk-Forward Optimization 維持

min_pips=0.6 固定（変更なし）

threshold最適化ロジック変更なし

安定性評価の観測系を完成

run_id 横断集約
→ thr_runs_summary.csv

固定(0.45) vs 毎回最適化 比較
→ thr_compare_fixed_vs_opt.csv

min_trades=200 / 500 / 1000 の安定性評価
→ thr_min_trades_eval.csv

CSVはすべて実生成・存在確認済み

ログに [THR_STABILITY] summary / comparison / min_trades eval saved を確認

dry-run では生成されない仕様も観測で確定

現時点の実データ結果（run_id=2点）

best_thr は すべて 0.45

固定(0.45) vs 最適化 → 差分なし（total_diff=0）

min_trades を 200 / 500 / 1000 に振っても best_thr 不変

fold内では揺れがあるが、全体集約では 0.45 が支配的

→ この相場断面では 0.45 は非常に安定

現時点の結論（作業仮説）

threshold=0.45 は
「一時的な偶然」より「戦略の性格」に近い可能性が高い

ただし run 数が少なく、時間方向の多様性がまだ不足

「壊れるかどうか」は今後の run 蓄積でのみ判定可能

禁止事項の遵守状況

fold別threshold運用：❌未実施

勝率最大化ルールへの変更：❌未実施

thresholdを特徴量に追加：❌未実施

ロジック条件追加：❌未実施

→ 全ルール遵守

#########################################################
要点サマリ（Visualize：Diff直線化の解消）

■ テーマ

Visualizeタブ：LightGBM Diff（buy-sell）がほぼ直線になる問題の原因確定と表示修正

■ 観測で確定した事実

GUI起動入口（PyQt6）：app/gui/main.py

起動コマンド：python -X utf8 -m app.gui.main（ログ出力まで観測済み）

[VIS][CHECK] 観測結果（logs/app.log）

std≈0.0015〜0.0021 / nunique=3

std > 0 かつ nunique > 1 → join事故（全バー同一値貼り付け）は否定

変動が微小なため、固定レンジ（例：ylim(-1,1)）だと 直線に見えると確定

■ 実施した修正（表示のみ）

app/gui/visualize_tab.py の diff 描画で固定だった ax_prob.set_ylim(-1.0, 1.0) を撤廃

diff の最大振幅から動的レンジを設定：

span = max(1.2*max(|diff|), 0.02)

ylim = [-span, +span]

diff が NaN/空などで振幅計算できない場合は 例外で落とさず (-1,1) にフォールバック

視認性補助として下段（diff軸）に Diff span=±... をタイトル表示（ログ増加なし）

■ 変更ファイル

app/gui/visualize_tab.py

■ 動作確認（実施済み）

python -X utf8 -m py_compile app/gui/visualize_tab.py ✅

python -X utf8 -m app.gui.main 起動 ✅

Visualize→Refresh で Diff が直線に見えず、変動が視認可能 ✅

[VIS][CHECK] が引き続き出力されることを確認 ✅

■ 結果

Diff “直線化に見える” 問題を 表示レンジ調整のみで解消
######################################################
