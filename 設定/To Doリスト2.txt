まず現状をざっくり整理して、そのうえで「これからやる作業1〜」を並べ直します。
このスレッドでは**一覧の作り直しだけ**やって、実際の実装は次のスレッドから1個ずつやっていきましょう。

---

## 1. いま分かっている「完了済み」たち

手元のファイルと前の会話を突き合わせると、少なくともここまでは終わっています。

### 1-1. 環境・骨格まわり

* Python 3.13 / 仮想環境 `.venv` / VS Code / PowerShell 7 まわりの整備

  * `仮想環境.txt` に `.venv\Scripts\Activate.ps1` がメモ済み。
* プロジェクト構成・開発ツール

  * `pyproject.toml`（ruff設定）、`pytest.ini`、`requirements.txt` などが揃っている。
  * `tests/test_sanity.py` で最低限の pytest が動作する状態。

### 1-2. AIまわり・バッチ

* LightGBM クラス分類モデル + キャリブレーション（Platt / Isotonic）構成

  * `tools/train_lightgbm.py` と `models/LightGBM_clf.pkl` 一式あり。
* 特徴量スケーラー学習スクリプト

  * `tools/train_scaler.py` で M15 CSV から特徴量を作り、StandardScaler を保存するところまで実装済み。
* Walkforward / 週次再学習パイプライン

  * `scripts/walkforward_train.py` / `scripts/walkforward_retrain.py` / `scripts/weekly_wf.ps1` が存在し、フェーズA〜Hの検証結果もファイル化済み。

### 1-3. 実行ロジック・リスク制御

* ATRゲートのヒステリシス、ATRトレーリング、side_bias 新ロジック

  * `作業6～8.txt` / `作業9.txt` / `作業10.txt` がすべて「作業X 結果」となっており、
    ATRヒステリシス・トレーリング・entry判定ロジックの新実装と検証コマンドが書かれている。 
* サーキットブレーカー & decision ログ

  * `scripts/cb_smoke.py` や `logs/decisions_*.jsonl` を前提にしたフェーズA〜Hの診断が `フェーズA~Hまでの結果.txt` にまとまっている。

### 1-4. バックテスト・可視化

* バックテスト実行とエクイティ曲線出力

  * `tools/backtest_run.py` と `tools/backtest_equity_curve.py` があり、`logs/backtest/…/equity_curve.csv` を出すところまでは動作確認済み。
* GUI 側のエクイティグラフ表示

  * エクイティ曲線の表示・ズーム・期間移動などは一通り実装＆何度か改良済み（マーカーは「出てないけどもういいや」とユーザー判断で一旦完了扱い）。

### 1-5. 週次ジョブ・タスクスケジューラ

* 週次再学習の自動実行

  * `scripts/register_weekly_task.ps1` / `scripts/setup_weekly_job.ps1` があり、
    `やるべきこと.txt` に書かれていた「register_weekly_task.ps1 の実行」も済んでいる（ユーザーが「週次再学習のタスクスケジューラ登録は完了」と発言）。

---

## 2. 「まだこれから」の代表的な仕様

元の To Do と仕様を見る限り、**まだ手をつけていない or 途中で止めているっぽいもの**はこの辺です。 

* バックテストタブで

  * 期間指定（From/To）＋「ALL」ボタン
  * 単純バックテスト vs Walkforward 産出結果の切替・重ね描画
* 複数PC（開発2台＋運用1台）でのデータパス完全整理

  * MT5 ヒストリの扱いを含め、「どのPCでも同じスクリプトで動く」状態まで詰める
* AIタブの仕上げ

  * 月間/週間損益グラフ、モデル名、検証指標、重要特徴量、SHAP上位3、学習日時、信頼度メーターなど
* ムード表示（「静穏」「ボラ急上昇」「反転警戒中」＋根拠吹き出し）
* drift 監視（PSI / Logloss）と警告表示
* M5/H1/M15 スタッキング & 出口戦略の高度化
* 「バックテストの結果を診断するAI」みたいな後付けアナリスト

この中から、**今のコードベースと最近の会話**に沿って、
「優先度高めで、1スレッド1作業で回せるサイズ」のものを並べ直します。

---

## 3. これからの作業リスト v2（作業1〜7）

ここからが新しい ToDo 本体です。
**この番号は「これからやる分」の通し番号**と思ってください（昔の作業6〜10とは別カウンタ）。

### 作業1：データパス & MT5 履歴パイプラインの最終整理

**目的**

* どのPCでも同じコマンドで

  * MT5 履歴 → CSV 生成
  * `data/` 配下に保存
    ができるようにし、`fxbot_path` / 環境変数のルールを確定させる。

**ざっくり中身**

* `fxbot_path.py` の仕様を確認し、「プロジェクトルート」「dataルート」の決め方を最終決定
* `scripts/export_mt5_history.py` / `scripts/make_csv_from_mt5.py` / `scripts/mt5_export_csv.py` のどれを正とするか決めて一本化
* 3台のPCで同じコマンド例で動くことを確認し、その使い方を `README.md` に追記

**完了判定（DoD）**

* 3台すべてで、例えばこんなコマンドが通る：

  ```powershell
  # 例
  .\.venv\Scripts\python.exe scripts\export_mt5_history.py --symbol USDJPY --timeframe M5
  ```

* 生成された CSV のパスと、GUI / 学習スクリプトが参照するパスが一致している

* `README.md` に「データ更新手順」が1セクションとしてまとまっている

---

### 作業2：バックテスト CLI に期間指定オプションを追加

**目的**

* `tools/backtest_run.py` に `--start-date` / `--end-date` などの引数を追加して、
  コマンドラインからバックテスト対象期間を絞れるようにする。

**ざっくり中身**

* `tools/backtest_run.py` に `argparse` を追加
* 期間指定があれば、その範囲でデータをフィルタしてバックテスト
* 出力フォルダ（例：`logs/backtest/…`）の命名に期間情報を含める

**完了判定**

* 例：

  ```powershell
  .\.venv\Scripts\python.exe tools\backtest_run.py --symbol USDJPY --tf M5 `
      --start-date 2024-07-01 --end-date 2024-12-31
  ```

  で、指定期間だけを対象に `equity_curve.csv` が生成される
* 指定なしで実行した場合は「全期間」で従来通り動く

---

### 作業3：GUI バックテストタブの期間指定＆「ALL」ボタン連動

**目的**

* GUI の Backtest タブから

  * From/To 日付ピッカー
  * 「ALL（ズームリセット）」ボタン
    を操作 → `backtest_run.py` を呼び出し、グラフを更新できるようにする。

**ざっくり中身**

* `app/gui/` 内の Backtest タブ実装ファイル（おそらく `backtest_tab.py` か `history_tab.py`）を特定
* 作業2で追加した CLI オプションに合わせて、バックエンド呼び出しロジックを修正
* 「ALL」ボタンで

  * 日付ピッカーを全期間にリセット
  * グラフのズームも全期間に戻す

**完了判定**

* GUI で

  * 任意の期間を指定してバックテスト → エクイティグラフがその期間だけに変わる
  * 「ALL」クリックでフル期間表示に戻る
* 例外が出ず、ログにも明らかなエラーが出ない

---

### 作業4：Backtest vs Walkforward 結果の切替・重ね描画

**目的**

* Backtest タブで

  * 素のバックテスト結果
  * Walkforward 検証（WFO）からのサマリ
    を切り替えたり、重ねて表示できるようにする。

**ざっくり中身**

* Walkforward の結果（PF, MaxDD, Sharpe, Win% など）がどのファイルに出ているかを確認

  * 例：`logs/retrain/report_*.json` や `フェーズA~Hまでの結果.txt` の形式を整理
* Backtest タブにラジオボタンやチェックボックスを追加

  * 「バックテストのみ」
  * 「Walkforwardサマリのみ」
  * 「両方」
* 同じグラフ上に

  * バックテストのエクイティ
  * Walkforward でのエクイティ or KPI
    を描画

**完了判定**

* GUIでモードを切り替えたとき、グラフのシリーズが切り替わる
* 少なくとも１つの WFO 結果について、数字が手計算と合っていることを確認

---

### 作業5：AIタブの KPI / FI / SHAP の「運用版」仕上げ

**目的**

* 仕様に書いてある AIタブの情報を、
  「最低限だが実運用に十分」なところまで埋める。

**ざっくり中身**

* `tools/dump_feature_importance.py` や `models/LightGBM_clf.features.json` を使って FI ランキングを取るロジックを整理
* 直近 Nトレードの集計から

  * 勝率 / PF / 最大DD / 連勝・連敗
    を計算する関数をどこか（services or tools）に定義
* GUI AIタブで

  * モデル名
  * 検証指標（Logloss, AUC など）
  * 運用指標（最近の勝率など）
  * 上位特徴量リスト
    を表示

**完了判定**

* GUIの AIタブを開くと、直近の `logs/decisions_*.jsonl` から集計した数字が表示される
* モデルを入れ替えた後に再起動すると、新しいモデル名／指標に更新される

---

### 作業6：デモ口座向け MT5 発注ラッパーの最初の一歩

**目的**

* これまでの `execution_stub` ベースの dryrun から一歩進めて、
  **MT5 デモ口座に対して実際に発注してみるための最小ラッパー**を作る。

**ざっくり中身**

* `core/mt5_client.py`（まだ無ければ新規）を作り、

  * 接続・ログイン
  * 成行発注（Buy/Sell）
  * 決済（Close）
    をラップ
* `app/services/execution_stub.py` を分離・整理して、

  * ロジック部分（トレーリング・サーキットブレーカー・ポジションガード）は共通
  * 実際の発注部分だけを新しい mt5_client に委譲
* `scripts/selftest_order_flow.py` で、
  「小ロットで1回発注 → すぐ決済」が通ることを確認

**完了判定**

* デモ口座で 0.01 ロット程度の試験トレードが

  * エラーなく発注
  * 約定
  * クローズ
    できる
* 決済結果が MT5 の履歴タブと `logs/decisions_*.jsonl` の両方で確認できる

---

### 作業7：バックテスト診断AI（v0）を作って遊ぶ

**目的**

* 「バックテスト結果をどう解釈するか？」を半自動化するための
  **診断スクリプト（ないし簡易AI）」の最初のバージョン**を作る。

**ざっくり中身**

* `logs/backtest/…/equity_curve.csv` と `logs/decisions_*.jsonl` を読み込む Python スクリプトを新規作成
* ざっくりルールベースでよいので、

  * トレンド相場での成績 vs レンジ相場での成績
  * 時間帯ごとの勝率
  * 大きなDD発生前後の特徴
    などを集計
* 結果をテキストレポートか簡易HTMLとして出力

**完了判定**

* 1コマンドで「バックテスト診断レポート」が生成される
* レポートを見て「この期間はATRが低すぎてENTRYほぼなし」など、
  人間が納得できるコメントが出ている

---

## 4. このあとの進め方（スレッド運用ルール）

このスレッドでは **「作業リストv2」の見直し**までやりました。

次のステップは：

1. 次の新しいスレッドを作る
2. その最初のメッセージで
   例）

   > 作業1から始めたい。
   > 作業1の手順と、必要な修正コードを詳しく教えて。

みたいに書いてスタートしてください。

そうしたら、**その作業専用スレッド**として

* やることの細分化
* どのファイルのどの行をどう直すか
* Codex にそのまま貼れるコードブロック
* 作業後の確認手順（コマンド・GUI操作）

をまとめて出します。

作業1が完了したら、そのスレッドで「完了」と書いて閉じて、
また新しいスレッドで「作業2をやりたい」と宣言して進める、というサイクルにしましょう。
そうしておくと、この巨大プロジェクトもレベル制RPGみたいに一歩ずつ攻略できます。
