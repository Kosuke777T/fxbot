（内蔵スケジューラ＋日本語版＋エディション構成）
0) 目的・ターゲット

目的：

MT5 + PyQt6 + AIモデル（LightGBM 他）を利用し、

月間3％前後のリターンを「目指す」 自動FX売買ボットを構築・運用する。

3％/月は達成義務ではなく KPI（目標指標） として扱う。

同時に、最大ドローダウン（資産ピーク比） -15〜-20％以内 を安全ラインとする。

ターゲットユーザー：

Windowsユーザー（日本語環境の個人トレーダー）

MT5を使った裁量トレーダーから、半自動〜自動に移行したい層

EAは触ったことがあるが「AI＋統計＋可視化」で運用を改善したい人

非機能的要件：

Windows 10 / 11 (64bit)

日本語UI（メニュー・メッセージ・ログ）

Windowsタスクスケジューラに依存しない
→ すべての定期実行は 内蔵スケジューラ で行う。

1) 全体アーキテクチャ

3レイヤ構成：

GUI層（app.gui） … PyQt6ベースの画面

サービス層（app.services） … AIサービス / KPI計算 / ログ / スケジューラ / ランキング etc.

コア層（app.core） … MT5ラッパー、戦略ロジック、バックテストエンジン

実行形態：

通常は GUIアプリとして起動。

将来的に「常駐モード（タスクトレイ常駐のみ）」にも対応できるよう、サービス層をGUIに強く依存させない設計にする。

設定・データ：

共通設定：config.yaml + config.local.yaml

モデル保存：models/

ログ：logs/

決定ログ：logs/decisions_*.jsonl

バックテスト結果：backtests/{profile}/...

2) エディション構成（Free / Basic / Pro / Expert / Master）
共通仕様

すべてのエディションで 同一の実行ファイル を使う。

機能差は「エディション情報（edition: free/basic/pro/expert/master）」で制御する。

Edition 情報は

ライセンス認証

設定ファイル

またはビルド時に埋め込み
のいずれかで決まる。

fxbot Free（無理のお試し版）

接続可能口座：デモ口座のみ

自動売買：OK（ただしロット上限小）

バックテスト：OK（期間制限なし）

内蔵スケジューラ：

画面上には表示するが、常に「OFF固定」（設定不可）

AIタブ：

KPIの基本項目のみ表示（今月損益％、勝率、PFなど）

Feature Importance / SHAP は非表示

ランキング：

他ユーザーのランキング閲覧のみ（自分の成績送信は不可）

fxbot Basic

接続可能口座：デモ＋本口座

自動売買：

単一ストラテジープロファイルで稼働

内蔵スケジューラ：

週1回 再学習＆WFO をON/OFFで切り替え可能（曜日・時刻はデフォルト値のみ変更不可）

AIタブ：

KPI + 月次リターン簡易表示

ランキング：

Basicエディションのランキング閲覧

「今月の成績を送信」ボタン有効

fxbot Pro

Basicのすべて＋

ストラテジー：

複数プロファイル（トレンド/レンジ 等）の切り替え

AIタブ：

Feature Importance

SHAP上位特徴（Top N）

内蔵スケジューラ：

複数ジョブ（再学習／診断レポート）が登録可能

曜日・時刻の編集可能

バックテスト診断AI：

v0（時間帯別・相場条件別集計）のレポート出力

ランキング：

Pro専用ランキング

自分の過去ランキング履歴（ローカル保存）も表示

fxbot Expert

Proのすべて＋

高度なフィルタ設定（ATR・時間帯・ボラティリティ帯など）をGUIから編集可

スケジューラ：

任意Pythonスクリプト（内部定義されたジョブ）の組合せで実行プランを作成可能

バックテスト診断AI：

追加の切り口（例：連敗中のみ抽出、DD直前の特徴など）

ランキング：

Expert専用ランキング（リターンとDDを考慮した複合スコアなど）

fxbot Master（開発者・自分専用）

一般販売なし。

すべての機能を制限なしで利用可能。

追加：

ランキング送信先URL、APIキー、テスト送信などの開発用ツール

内蔵スケジューラに任意ジョブを登録可能（バックテスト一括実行、モデル比較など）

3) 内蔵スケジューラ仕様（JobScheduler）
3-1. 基本方針

Windowsタスクスケジューラは使わない。

アプリ内部に JobScheduler（常駐サービス）を持ち、

指定された時間になったら

指定された「ジョブ」をサブプロセスまたはスレッドで実行する。

GUIが起動している間のみ動くのか、トレイ常駐にするのかは段階的に拡張：

v1：GUI起動中のみ動作（週末はPC＋アプリ起動が前提）

v2：タスクトレイ常駐モードで、ウィンドウを閉じてもスケジューラが動き続ける（Expert / Master向け）

3-2. ジョブの種類（v1）

再学習＋Walk-Forward 検証：

python -m scripts.walkforward_retrain --profile ...

バックテスト診断レポート生成：

python -m scripts.diagnose_backtest --profile ...

将来：

ログ圧縮、バックアップなど

3-3. スケジュール表現

config.scheduler.yaml または config.yaml の scheduler セクションに記述：

scheduler:
  enabled: true
  jobs:
    - id: weekly_retrain
      enabled: true
      edition_min: basic
      weekday: 5        # 0=月, 6=日
      hour: 3
      minute: 0
      command: "python -m scripts.walkforward_retrain --profile default"
    - id: weekly_report
      enabled: true
      edition_min: pro
      weekday: 6
      hour: 8
      minute: 0
      command: "python -m scripts.diagnose_backtest --profile default"


Pro以上では GUI から編集可能。

Basic では weekly_retrain ON/OFF だけ可能（曜日・時刻は固定）。

3-4. JobScheduler の動作

アプリ起動時に config を読み込んで JobScheduler インスタンスを作成。

バックグラウンドスレッドで

30秒〜1分ごとに現在時刻をチェック

実行条件を満たすジョブだけを一度実行

実行履歴（成功/失敗、開始・終了時刻）を logs/scheduler.log に残す。

同一ジョブは同じ日付・同じタイミングで二重起動されないよう last_run_at を管理。

4) ランキング機能仕様（バージョン別）
4-1. 目的

エディションごとのユーザーが「月次リターン」を共有し、モチベーションとベンチマークを得る。

仕様としては “任意参加のランキング機能” にとどめる（利用しなくても本体機能はフル動作）。

4-2. クライアント側

サービス層に RankingService を実装：

月次リターンの集計（バックテスト・実運用の両方）

ペイロード（ニックネーム、年月、リターン％、エディション）生成

送信結果のローカル保存（再送制御）

GUI：

「ランキング」タブ（ or AIタブ内のサブタブ）

ドロップダウンでエディション選択（Basic/Pro/Expert 別）

自分の順位・自分の月次リターン表示

Freeは閲覧のみ、Basic以上で送信ボタン有効。

4-3. サーバ側（ここでは要求だけ）

/api/ranking/submit：

認証済ユーザーからの成績送信

/api/ranking/top?edition=pro&year=2025&month=11：

上位N名を返す

今の段階では、クライアント側はローカルモック実装から始めて、サーバが準備できたら切り替える。

5) 日本語UI・表記ルール

メニュー／ボタン／ダイアログはすべて日本語表記。

単語例：

「利益率」,「最大ドローダウン」,「勝率」,「プロフィットファクター（PF）」,「週次再学習」,「スケジュール設定」など。

ログ出力も日本語＋簡単な英語併記（例：「MT5 接続に失敗しました (login error)」）。

文字コードはすべて UTF-8（BOMなし）に統一する。
